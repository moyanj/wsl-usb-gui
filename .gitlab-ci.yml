stages:
  - build
  - release

#################################
# Build the Windows MSI Installer
#################################
build:
  stage: build
  tags:
    - windows
    - windows-1809
  script:
    # Install Rye
    - wget https://github.com/mitsuhiko/rye/releases/download/0.11.0/rye-x86_64-windows.exe -UseBasicParsing -OutFile rye.exe
    - $env:path += ";."

    - rye sync
    - rye run python -m __version__ --python --short --save

    # Install WIX Toolkit
    - wget https://github.com/wixtoolset/wix3/releases/download/wix311rtm/wix311-binaries.zip -UseBasicParsing -OutFile c:\wix311-binaries.zip
    - mkdir c:\\wix311
    - Expand-Archive -Path c:\wix311-binaries.zip -DestinationPath c:\\wix311\\bin
    - $env:WIX="C:\\wix311\\"
    - $env:PYTHONIOENCODING="UTF-8"

    # Build app
    - $version = @(rye run python -m __version__ --python --short)
    - .\pyoxidizer.exe build msi_installer --release --var version "$version"

    - copy-item build\\x86_64-pc-windows-msvc\\release\\msi_installer\\*.msi .\\

  artifacts:
    name: "WSL-USB-GUI-$CI_COMMIT_SHORT_SHA"
    paths:
      - .\\WSL*.msi
    expire_in: 1 week
  except:
    - tags


release this commit:
  when: manual
  stage: release
  image: python:3
  only: [main]
  before_script:
    - git config --global user.email "$GITLAB_USER_EMAIL"
    - git config --global user.name "$GITLAB_USER_NAME"
  script:
    - pip install git-versioner
    - git status
    - git reset --hard HEAD
    - git-versioner --tag
    # ensure git lfs hook doesn't block push
    - rm .git/hooks/pre-push
    # Requires maintainer write_repository project access token in protected env var: GIT_TOKEN
    - git push --tags https://root:$GIT_TOKEN@$CI_SERVER_HOST/$CI_PROJECT_PATH.git HEAD:main


########################################################################
# Upload the built installer to the tags page on Gitlab for the release
########################################################################
publish:
  stage: release
  image: python:3
  variables:
    GIT_STRATEGY: none
    GIT_SUBMODULE_STRATEGY: none
  script:
    - pip install -U gitlab-release gitlab-download-artifacts
    - gitlab-download-artifacts "${CI_PROJECT_URL}@${CI_COMMIT_SHORT_SHA}" build
    - gitlab-release ./*.msi
  only:
    - tags
  artifacts:
    name: "WSL-USB-GUI-${CI_COMMIT_TAG}"
    expire_in: never
    paths:
      - ./*.msi
